---
// @src/pages/proyectos/[slug].astro (VERSIÓN CON SINTAXIS CORREGIDA)
export const prerender = true;

import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { mdToHtml } from '../../utils/markdown';

const allServices = await getCollection('servicios');

export async function getStaticPaths() {
  const projects = await getCollection('proyectos');
  return projects.map(project => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props;
if (!project) {
  return new Response(null, { status: 404, statusText: 'No encontrado' });
}

const selectedServiceTitles = project.data.services_list ?? [];
const relatedServices = allServices.filter(service => 
  selectedServiceTitles.includes(service.data.title)
);

const { titulo, summary, client_name, date, project_details, gallery } = project.data;
---

<Layout title={titulo ?? 'Proyecto'} description={summary ?? 'Detalles del proyecto.'}>
  <article class="bg-secondary">
    <header class="relative h-[28rem] sm:h-96 flex items-center justify-center text-center text-white">
      <div 
        class="absolute top-0 left-0 w-full h-full bg-cover bg-center" 
        style={`background-image: url('${gallery?.[0]?.image_path ?? '/assets/uploads/logo.jpg'}')`}
      ></div>
      <div class="absolute top-0 left-0 w-full h-full bg-primary opacity-80"></div>
      <div class="relative z-10 p-8">
        <h1 class="text-4xl md:text-5xl font-serif font-bold text-white mt-16">{titulo}</h1>
        <p class="text-xl mt-2">Cliente: <strong>{client_name}</strong></p>
        {date && <time class="text-sm mt-1 block">{new Date(date).toLocaleDateString('es-CL')}</time>}
      </div>
    </header>

    <div class="max-w-4xl mx-auto p-8 md:p-12">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-2">
          {summary && (
            <div class="prose prose-xl max-w-none mb-12 border-b border-gray-300 pb-8">
              <h2 class="font-serif text-3xl font-bold text-primary mb-4">Resumen del Desafío</h2>
              <div set:html={mdToHtml(summary)}></div>
            </div>
          )}

          {project_details && (
            <div class="prose prose-xl max-w-none">
              <h2 class="font-serif text-3xl font-bold text-primary mb-4">Solución y Resultados</h2>
              <div set:html={mdToHtml(project_details)}></div>
            </div>
          )}

          {!summary && !project_details && (
            <p class="text-gray-500">No hay más detalles disponibles para este proyecto.</p>
          )}
        </div>

        <aside>
          <div class="bg-white p-6 shadow-lg  sticky top-28">
            <h3 class="text-xl font-serif font-bold text-primary border-b-2 border-accent pb-2 mb-4">Servicios Realizados</h3>
            {relatedServices.length > 0 ? (
              <ul class="flex flex-wrap gap-2">
                {relatedServices.map(service => (
                  <li class="bg-accent/10 text-accent font-semibold text-sm py-1 px-3 rounded-full">
                    {service.data.title}
                  </li>
                ))}
              </ul>
            ) : (
              <p class="text-sm text-gray-500">No hay servicios especificados.</p>
            )}
          </div>
        </aside>
      </div>

      {gallery && gallery.length > 0 && (
         <section class="mt-16">
          <h2 class="text-3xl font-serif font-bold text-primary text-center mb-8">Galería de Imágenes</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
            {gallery.map(item => (
              <a href={item.image_path} target="_blank">
                <img 
                  src={item.image_path} 
                  alt={`Imagen del proyecto ${titulo}`} 
                  loading="lazy" 
                  class="w-full h-56 object-cover shadow-md transition-transform duration-300 hover:scale-105"
                />
              </a>
            ))}
          </div>
        </section>
      )}
    </div>
  </article>
</Layout>